<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Estoque do Armazém (Warehouse)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 2rem; }
        .produto-row.updated {
            background-color: #fff3cd; /* Amarelo claro para destacar a atualização */
            transition: background-color 1s ease-out;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mb-4">Estoque em Tempo Real</h1>
        <div class="alert alert-info">Esta página se conecta via WebSockets ao back-end. Quando um pedido é feito no Storefront, o estoque aqui é atualizado automaticamente.</div>
        <table class="table table-bordered table-striped">
            <thead class="table-dark">
                <tr>
                    <th>ID</th>
                    <th>Nome</th>
                    <th>Estoque</th>
                </tr>
            </thead>
            <tbody id="tabela-produtos">
                <!-- Os produtos serão inseridos aqui via JavaScript -->
            </tbody>
        </table>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.6.1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const tabelaProdutos = document.getElementById('tabela-produtos');

            // 1. Carregar os produtos iniciais via API REST
            fetch('/api/produtos')
                .then(response => response.json())
                .then(produtos => {
                    produtos.forEach(produto => {
                        const row = document.createElement('tr');
                        row.id = `produto-${produto.id}`;
                        row.classList.add('produto-row');
                        row.innerHTML = `
                            <td>${produto.id}</td>
                            <td>${produto.nome}</td>
                            <td class="fw-bold">${produto.estoque}</td>
                        `;
                        tabelaProdutos.appendChild(row);
                    });
                });

            // 2. Conectar ao WebSocket
            function connectWebSocket() {
                const socket = new SockJS('/ws-warehouse');
                const stompClient = Stomp.over(socket);

                stompClient.connect({}, function (frame) {
                    console.log('Conectado ao WebSocket: ' + frame);
                    
                    // 3. Inscrever-se no tópico de atualização de estoque
                    stompClient.subscribe('/topic/estoque', function (message) {
                        const produtoAtualizado = JSON.parse(message.body);
                        console.log('Mensagem recebida: ', produtoAtualizado);
                        
                        // 4. Atualizar a tabela
                        const row = document.getElementById(`produto-${produtoAtualizado.id}`);
                        if (row) {
                            const estoqueCell = row.cells[2];
                            estoqueCell.textContent = produtoAtualizado.estoque;
                            
                            // Animação para destacar a mudança
                            row.classList.add('updated');
                            setTimeout(() => {
                                row.classList.remove('updated');
                            }, 1500);
                        }
                    });
                }, function(error) {
                    console.error('Erro de WebSocket, tentando reconectar em 5 segundos...', error);
                    setTimeout(connectWebSocket, 5000);
                });
            }

            connectWebSocket();
        });
    </script>
</body>
</html>
